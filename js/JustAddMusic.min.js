"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),JustAddMusic=function(){function e(t){_classCallCheck(this,e),t&&"string"!=typeof t||(t={src:t}),this.gain=t.gain||1,this.onstart=t.onstart,this.ontick=t.ontick,this.onended=t.onended,this.onprogress=t.onprogress,this.label=t.label||"",this.loop=!!t.loop,this._paused=!!t.paused,this._keyControl=!1,this._tickInterval=0,this._tickIntervalID=0,this._request=null,this._playT=0,this._pausedT=0,this._ui=!1,this._uiDiv=null,this._audioData=null,this._deltaT=t.deltaT||50,this._avgT=t.avgT||150,this._maxT=Math.max(this._deltaT,this._avgT),this._allAdj=.1,this._bandAdj=.1,this._hitThresholds={low:2,mid:2,high:2,all:2},this._context=null,this._gainNode=null,this._sourceNode=null,this._buffer=null,this._muteNode=null,this._nullNode=null,this._bound_handleKeyDown=this._handleKeyDown.bind(this),this._initAudio(),this._initUI(),this._initDropTarget(t.dropTarget),this.tickInterval=t.tickInterval,this.loadAudio(t.src),this.ui=void 0===t.ui||t.ui,this.keyControl=void 0===t.keyControl||t.keyControl,this.volume=void 0===t.volume?1:t.volume}return _createClass(e,[{key:"loadAudio",value:function(e){if(this.abort(),e){this._updateLoadUI(0);var t=this._request=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.addEventListener("load",this._handleURILoad.bind(this)),t.addEventListener("progress",this._handleURIProgress.bind(this)),t.send()}}},{key:"abort",value:function(){this._request&&this._request.abort(),this._request=null}},{key:"play",value:function(){var e=this,t=(this._sourceNode&&this._sourceNode.buffer)!==this._buffer,i=this._pausedT;this.pause();var n=this._sourceNode=this._context.createBufferSource();n.buffer=this._buffer,n.connect(this._nullNode),n.start(0,i),n.addEventListener("ended",function(t){return e._handleEnded(t)}),this._playT=this._context.currentTime-i,this._paused=!1,t&&this.onstart&&this.onstart()}},{key:"pause",value:function(){this._sourceNode&&!this._paused&&(this._sourceNode.stop(),this._sourceNode.disconnect(),this._sourceNode=null,this._pausedT=this._context.currentTime-this._playT,this._paused=!0)}},{key:"stop",value:function(){this.abort(),this.pause(),this._pausedT=this._playT=0}},{key:"seek",value:function(e){this._buffer&&(this.playT=0,this._pausedT=Math.min(this._buffer.duration-.001,Math.max(0,e)),this._paused||this.play())}},{key:"skip",value:function(e){this.seek(this._context.currentTime-this._playT+e)}},{key:"tick",value:function(){if(this._sourceNode&&(this._updateTimeUI(),this.ontick||!this._tickIntervalID)){!this._allAnalyser&&this._initAnalyser();var e=this._oldObj||{low:{},mid:{},high:{},all:{}},t=this._audioData;this._oldObj=null,t.unshift(e);var i=e.t=1e3*this._context.currentTime;return this._getVal(e.all,this._allAnalyser,i,!0),this._getVal(e.low,this._lowAnalyser,i),this._getVal(e.mid,this._midAnalyser,i),this._getVal(e.high,this._highAnalyser,i),this._calculate(),this.ontick&&this.ontick(e),e}}},{key:"toString",value:function(){return"[JustAddMusic]"}},{key:"_initAudio",value:function(){var e=this._context=new(window.AudioContext||window.webkitAudioContext);this._gainNode=e.createGain(),this._gainNode.connect(e.destination),this._nullNode=e.createGain(),this._nullNode.connect(this._gainNode)}},{key:"_initAnalyser",value:function(){if(!this._muteNode){this._audioData=[];var e=this._muteNode=this._context.createGain();e.gain.value=0,e.connect(this._context.destination),this._lowAnalyser=this._createBandAnalyser(40,250),this._midAnalyser=this._createBandAnalyser(250,2e3),this._highAnalyser=this._createBandAnalyser(2e3,6e3),this._allAnalyser=this._createBandAnalyser()}}},{key:"_createBandAnalyser",value:function(e,t){var i=void 0,n=this._context,a=n.createDynamicsCompressor();if(a.threshold.value=-36,a.knee.value=35,a.ratio.value=10,a.release.value=0,a.connect(this._muteNode),a.attack.value=1,a.attack.linearRampToValueAtTime(0,n.currentTime+.1),e||t){var s=Math.sqrt(e*t),o=s/(t-e);i=n.createBiquadFilter(),i.type="bandpass",i.Q.value=o,i.frequency.value=s,i.connect(a)}return this._nullNode.connect(i||a),a}},{key:"_getVal",value:function(e,t,i,n){var a=t.reduction.value,s=n?this._allAdj:this._bandAdj;return a=(void 0===a?t.reduction:a)*-s,a>1&&(s/=a,a=1,n?this._allAdj=s:this._bandAdj=s),e.val=a*this.gain}},{key:"_calculate",value:function(){for(var e=this._audioData,t=e[0],i=t.t,n=this._hitThresholds,a=e[1],s=a,o=0,r=1,h=e.length;r<h;r++){var u=e[r],l=u.t;l>=i-this._avgT&&(o=r),l>=i-this._deltaT&&(s=u),l<i-this._maxT&&(this._oldObj=e.pop(),h--)}for(var d in t){(function(r){var h=t[r],u=h.val;if(void 0===u)return"continue";h.avg=o?e.reduce(function(e,t,i){return i>o?e:e+t[r].val},0)/o:0,h.delta=s?u-s[r].val:0,h.trend=s?h.avg-e[o][r].avg:0;var l=n[r],d=a?(i-a.t)/16:1;h.hit=!1,a&&!a[r].hit&&Math.pow(u,1.3)>1.3*l&&(h.hit=!0),n[r]=Math.max(.1,u,l-.15*(l-u)*d)})(d)}}},{key:"_initDropTarget",value:function(e){void 0===e&&(e=window),"string"==typeof e&&(e=document.querySelector(e)),e&&(e.addEventListener("drop",this._handleDrop.bind(this)),e.addEventListener("dragenter",this._handleDragEnter.bind(this)),e.addEventListener("dragleave",this._handleDragLeave.bind(this)),e.addEventListener("dragover",this._handleDragOver.bind(this)),this._updateUI("drop an MP3 to play"))}},{key:"_decode",value:function(e){this._context.decodeAudioData(e,this._handleBufferDecode.bind(this)),this._updateUI("decoding...")}},{key:"_initUI",value:function(){(this._uiDiv=document.createElement("div")).className="jam-ui";var e=document.createElement("style");e.innerHTML=".jam-ui{padding:0.75em;font-size:10pt;font-family:arial,sans-serif;background:#000;color:#FFF;z-index:100;position:absolute;bottom:0;left:0;}",document.head.insertBefore(e,document.head.firstChild)}},{key:"_updateLoadUI",value:function(e){this._updateUI(Math.round(100*e)+"%")}},{key:"_updateTimeUI",value:function(){if(this._buffer){var e=this._formatTime(Math.min(this._buffer.duration,this._context.currentTime-this._playT));e+=" / "+this._formatTime(this._buffer.duration),this._updateUI(e)}}},{key:"_formatTime",value:function(e){var t=e/60|0,i=e-60*t|0;return t+":"+(i<10?"0":"")+i}},{key:"_updateUI",value:function(e){var t=this._uiDiv;t.style.display=e?"inline-block":"none",t.innerHTML=this.label+e}},{key:"_handleKeyDown",value:function(e){var t=e.key||e.keyIdentifier;if(" "===(t=t.replace("Arrow",""))||"U+0020"===t)this.paused=!this.paused;else if("Enter"===t)this._pausedT=0,this.play();else if("Up"===t||"Down"===t)this.volume+=.1*("Up"===t?1:-1);else if("Left"===t||"Right"===t){var i=("Left"===t?-1:1)*(e.shiftKey?15:5)*(e.altKey?12:1);this.skip(i)}}},{key:"_handleEnded",value:function(e){this.loop?this.seek(0):this.onended&&this.onended()}},{key:"_handleDragEnter",value:function(e){this._handleDragLeave(e);var t=e.currentTarget;(t===window?document.body:t).className+=" jam-drop"}},{key:"_handleDragLeave",value:function(e){e.preventDefault();var t=e.currentTarget,i=t===window?document.body:t;i.className=i.className.replace(/\b\s?jam-drop\b/,"")}},{key:"_handleDragOver",value:function(e){this._handleDragEnter(e)}},{key:"_handleDrop",value:function(e){this._handleDragLeave(e),this.abort();var t=new FileReader;t.addEventListener("load",this._handleDropLoad.bind(this)),t.readAsArrayBuffer(e.dataTransfer.files[0])}},{key:"_handleDropLoad",value:function(e){this._decode(e.target.result)}},{key:"_handleURILoad",value:function(e){this._decode(e.target.response),this._request=null}},{key:"_handleURIProgress",value:function(e){var t=e.loaded/e.total;this.onprogress&&this.onprogress(t),this._updateLoadUI(t)}},{key:"_handleBufferDecode",value:function(e){this._buffer=e,this._pausedT=0,this._playT=this._context.currentTime,this._updateTimeUI(),this._paused||this.play()}},{key:"paused",get:function(){return this._paused},set:function(e){e?this.pause():this.play()}},{key:"keyControl",get:function(){return this._keyControl},set:function(e){e=!!e,this._keyControl!==e&&(this._keyControl=e,e?document.addEventListener("keydown",this._bound_handleKeyDown):document.removeEventListener("keydown",this._bound_handleKeyDown))}},{key:"tickInterval",get:function(){return this._tickInterval},set:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16;clearInterval(this._tickIntervalID),this._tickIntervalID=e>0?setInterval(this.tick.bind(this),e):0}},{key:"volume",get:function(){return this._gainNode.gain.value},set:function(e){this._gainNode.gain.value=Math.max(0,Math.min(2,e))}},{key:"ui",get:function(){return this._ui},set:function(e){if(e=!!e,this._ui!==e){this._ui=e;var t=this._uiDiv;e?document.body.appendChild(t):t.parentNode.removeChild(t)}}},{key:"audioData",get:function(){return this._audioData[0]||{vol:0,avg:0,delta:0,avgDelta:0,t:0}}}]),e}();